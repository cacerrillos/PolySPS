<!DOCTYPE html>
<!--
A comment describing this element

Example:

    <my-elem></my-elem>

Example:

    <my-elem>
      <h2>Hello my-elem</h2>
    </my-elem>

@demo demo/index.html
-->

<dom-module id="sps-app">
  <link rel="import" href="../bower_components/polymer/polymer.html">
  <link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
  <link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
  <link rel="import" href="../bower_components/iron-pages/iron-pages.html">
  <link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
  <link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
  <link rel="import" href="../bower_components/paper-fab/paper-fab.html">
  <link rel="import" href="../bower_components/neon-animation/neon-animations.html">
  <link rel="import" href="../bower_components/neon-animation/neon-animatable.html">
  <link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">


  <link rel="import" href="../bower_components/paper-button/paper-button.html">
  <link rel="import" href="../bower_components/paper-material/paper-material.html">
  <link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
  <link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
  <link rel="import" href="../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
  <link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
  <link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
  <link rel="import" href="../bower_components/paper-menu/paper-menu.html">
  <link rel="import" href="../bower_components/paper-item/paper-item.html">
  <link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
  <link rel="import" href="../bower_components/paper-styles/paper-styles.html">
  <link rel="import" href="../bower_components/paper-toast/paper-toast.html">
  <link rel="import" href="../bower_components/iron-icon/iron-icon.html">
  <link rel="import" href="../bower_components/iron-icons/iron-icons.html">
  <link rel="import" href="../bower_components/iron-icons/social-icons.html">
  <link rel="import" href="../bower_components/iron-icons/maps-icons.html">
  <link rel="import" href="../bower_components/paper-input/paper-input.html">
  <link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
  <link rel="import" href="../bower_components/paper-datatable/paper-datatable.html">
  <link rel="import" href="sps-login.html">

  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <iron-ajax auto id="adminStatusAjax" url="../../api/1.0/admin/" handle-as="json" last-response="{{adminStatus}}"></iron-ajax>
    <paper-drawer-panel id="mainPanel" on-paper-responsive-change="onresp">
      <paper-header-panel drawer class="vertical layout">
        <paper-toolbar>
          <div style="color:#FFFFFF"></div>
        </paper-toolbar>
        <paper-menu id="sidebarMenu" class="flex" attr-for-selected="data-page">
          <paper-icon-item on-click="goToPageOnClick" data-page="signup" hidden="{{adminStatus.is_admin}}">
            <iron-icon icon="icons:event-seat" item-icon></iron-icon><span>Sign-Up</span>
          </paper-icon-item>
          <paper-icon-item on-click="goToPageOnClick" data-page="dashboard">
            <iron-icon icon="icons:dashboard" item-icon></iron-icon><span>Dashboard</span>
          </paper-icon-item>
          <paper-icon-item on-click="goToPageOnClick" data-page="presentations">
            <iron-icon icon="social:people" item-icon></iron-icon><span>Presentations</span>
          </paper-icon-item>
          <paper-icon-item on-click="goToPageOnClick" data-page="viewers">
            <iron-icon icon="social:people-outline" item-icon></iron-icon><span>Viewers</span>
          </paper-icon-item>
          <paper-icon-item on-click="goToPageOnClick" data-page="dates" hidden="{{!adminStatus.is_admin}}">
            <iron-icon icon="icons:date-range" item-icon></iron-icon><span>Dates</span>
          </paper-icon-item>
          <paper-icon-item on-click="goToPageOnClick" data-page="blocks" hidden="{{!adminStatus.is_admin}}">
            <iron-icon icon="icons:view-list" item-icon></iron-icon><span>Blocks</span>
          </paper-icon-item>
          <paper-icon-item on-click="goToPageOnClick" data-page="locations" hidden="{{!adminStatus.is_admin}}">
            <iron-icon icon="maps:place" item-icon></iron-icon><span>Locations</span>
          </paper-icon-item>
        </paper-menu>
        <polyquiz-admin-login-form hidden="[[adminStatus.is_admin]]"></polyquiz-admin-login-form>
        <paper-icon-item hidden="[[!adminStatus.is_admin]]" on-click="doLogout">
          Log Out
        </paper-icon-item>
        <paper-item disabled>
        </paper-item>
      </paper-header-panel>
      <paper-scroll-header-panel class="flex" main id="scrollheader" fixed>
        <paper-toolbar>
          <paper-icon-button icon="icons:menu" paper-drawer-toggle></paper-icon-button>
          <span class="title">Senior Presentations - <span>[[pageTitle]]</span></span>
          <paper-button on-click="goToPageOnClick" class="smallbuttons" data-page="home"><iron-icon icon="icons:home"></iron-icon><span class="not-small"> Home</span></paper-button>
          <paper-button on-click="goToPageOnClick" class="smallbuttons" data-page="takeaquiz"><iron-icon icon="icons:content-paste"></iron-icon><span class="not-small"> Take A Quiz</span></paper-button>
          
          <paper-button on-click="goToPageOnClick" class="smallbuttons" data-page="admin"><iron-icon icon="icons:settings"></iron-icon><span class="not-small"> Manage</span></paper-button>
          
        </paper-toolbar>
        <div class="layout horizontal">
          <div class="flex"></div>
          <paper-spinner id="pageLoadSpinner"></paper-spinner>
          <div class="flex"></div>
        </div>
        <neon-animated-pages id="pageSelector" attr-for-selected="data-page" entry-animation="fade-in-animation" exit-animation="fade-out-animation">
          <polyquiz-page-home data-page="home"></polyquiz-page-home>
          <polyquiz-page-takeaquiz data-page="takeaquiz" ctx="[[ctx]]"></polyquiz-page-takeaquiz>
          <polyquiz-page-admin data-page="admin" ctx="[[ctx]]"></polyquiz-page-admin>
          <polyquiz-page-login data-page="login" ctx="[[ctx]]"></polyquiz-page-login>
          <polyquiz-page-sessions data-page="sessions" ctx="[[ctx]]"></polyquiz-page-sessions>
          <polyquiz-page-quiz data-page="quiz" ctx="[[ctx]]"></polyquiz-page-quiz>
          <polyquiz-page-quiz-edit data-page="quizedit" ctx="[[ctx]]"></polyquiz-page-quiz-edit>
        </neon-animated-pages>

        <iron-ajax
        id="getLimits"
           auto
           url="../api/1.0/limits/?totals"
           handle-as="json"
           last-response="{{limits}}"></iron-ajax>
        <iron-ajax
           auto
           url="../api/1.0/grade_levels/"
           handle-as="json"
           last-response="{{grade_levels}}"></iron-ajax>
          <template is="dom-repeat" items="{{_objectArrayToArray(limits)}}">
          
            <paper-datatable data="{{_objectArrayToArray(item)}}" selectable multi-selection>
              <paper-datatable-column header="Presentation" property="presentation_id"></paper-datatable-column>
              <paper-datatable-column header="Grade Level" property="grade_level"></paper-datatable-column>
              
              <paper-datatable-column header="Limit" property="amount"></paper-datatable-column>
              <template is="dom-repeat" items="{{_objectArrayToArray(grade_levels)}}" as="grades">
                <paper-datatable-column header="{{grades.grade_name}}" property="amount"></paper-datatable-column>
              </template>
              <paper-datatable-column header="Total" property="total"></paper-datatable-column>
            </paper-datatable>
          </template>
      </paper-scroll-header-panel>
      
    </paper-drawer-panel>
    <paper-toast id="globalToast"></paper-toast>
  </template>
  <script>
    Polymer({
      is: 'sps-app',
      properties: {
        page: {
          type: String
        },
        pageTitle: {
          type: String,
          value: "Home"
        },
        limits: {
          type: Object
        },
        grade_levels: {
          type: Object
        },
        adminStatus: {
          type: Object
        },
        ctx: {
          type: Object,
          observer: '_onContextChanged'
        }
      },
      listeners: {
        'firetoast': 'fireToast',
        'polyquiz-admin-check-status': 'checkAdminStatus',
        'polyquiz-admin-do-logout': 'doLogout',
        'polyquiz-admin-status': 'onAdminStatusChanged'
      },
      _objectArrayToArray: function(arr) {
        var v = $.map(arr, function(value, index) { return [value]; });
        //console.log(v);
        return $.map(arr, function(value, index) { return [value]; });
      },
      fireToast: function(details) {
        this.fireToastNonEvent(details.detail.message);
      },
      fireToastNonEvent: function(text){
        this.$.globalToast.text = text;
        this.$.globalToast.show();
      },
      doLogout: function(e) {
        this.$.logoutAjax.generateRequest();
      },
      _onResize: function() {
        this.fire('polyquiz-resize');
      },
      _onContextChanged: function(e) {
        console.log(this.page);
        this.$.pageSelector.select(this.page);
      },
      goToPageOnClick: function(e) {
        var pageId = "";
        if(e.target.getAttribute('data-page')) {
          pageId = e.target.getAttribute('data-page');
        } else if(e.target.parentNode.getAttribute('data-page')) {
          pageId = e.target.parentNode.getAttribute('data-page');
        }
        page('#!/' + pageId);
      },
      ready: function() {
        //this.$.adminStatusAjax.generateRequest();
        this.$.mainPanel.responsiveWidth = "768px";
        var self = this;
        setInterval(function() {
          self.$.getLimits.generateRequest();
        }, 3000);
      }
    });
  </script>
</dom-module>
<!--
A comment describing this element

Example:

    <my-elem></my-elem>

Example:

    <my-elem>
      <h2>Hello my-elem</h2>
    </my-elem>

@demo demo/index.html
-->

<!doctype html>
<dom-module id="polyquiz-admin-login-request">
  
  <style is="custom-style">
    paper-dialog {
      background-color: white;
      padding: 10px;
    }
  </style>

  <template>
    <paper-dialog id="mainDialog" class="layout vertical" on-iron-overlay-closed="onClosed">
      <h2>Log In Required</h2>
      <p>Please login to access this page.</p>
      <polyquiz-admin-login-form cancelable on-login-cancel="onLoginCancel"></polyquiz-admin-login-form>
    </paper-dialog>
  </template>

  <script>
  Polymer({
    is: 'polyquiz-admin-login-request',
    properties: {

    },
    open: function() {
      this.$.mainDialog.open();
    },
    close: function() {
      this.$.mainDialog.close();
    },
    onClosed: function(e) {
      if(this.$.mainDialog.canceled) {
        page('/admin');
      }
    },
    onLoginCancel: function(e) {
      this.$.mainDialog.cancel();
    },
    ready: function() {
      this.$.mainDialog.withBackdrop = true;
    }
  });
  </script>
</dom-module>
<dom-module id="polyquiz-admin-login-form">
  <link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
  <link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">

  
  <style is="custom-style">
    form {
      margin-left: 10px;
      margin-right: 10px;
    }
    h3 {
      margin-top: .25em;
      margin-bottom: .25em;
    }
  </style>

  <template>
    <div class="layout horizontal">
      <div class="flex"></div>
      <h3>Log In</h3>
      <div class="flex"></div>
    </div>
    <iron-ajax id="loginAjax" method="POST" handle-as="json" on-request="reqCB" on-response="loginCallback" url="../api/1.0/admin/login"></iron-ajax>
    <form id="adminlogin">
      <paper-input id="user" name="user" label="Email Address" on-input="loginFieldsCheck" on-keydown="checkForEnter"></paper-input>
      <paper-input id="pass" name="pass" label="Password" on-input="loginFieldsCheck" on-keydown="checkForEnter" type="password"></paper-input>
      <div class="layout horizontal" style="margin-top: 5px;">
        <div class="flex"></div>
          <paper-button id="loginButton" on-click="submitLogin" raised disabled><paper-spinner id="loginSpinner" style="display:none;"></paper-spinner><span>[[buttonText]]</span></paper-button>
          <paper-button id="cancelButton" on-click="doCancel" raised hidden="[[!cancelable]]">Cancel</paper-button>
        <div class="flex"></div>
      </div>
    </form>
  </template>

  <script>
    Polymer({
      is: "polyquiz-admin-login-form",
      properties: {
        cancelable: {
          type: Boolean,
          value: false
        },
        sidebarpage: {
          type: Number,
          value: 0
        },
        buttonText: {
          type: String,
          value: "Log In"
        }
      },
      loginFieldsCheck: function(e) {
        if(this.$.user.value.length > 0 && this.$.pass.value.length > 0){
          this.$.loginButton.disabled = false;
          return true;
        } else {
          this.$.loginButton.disabled = true;
          return false;
        }
      },
      checkForEnter: function(e) {
         if(e.keyCode === 13) {
          this.submitLogin();
         }
      },
      doCancel: function() {
        this.$.user.value = "";
        this.$.pass.value = "";
        this.fire('login-cancel');
      },
      submitLogin: function() {
        if(this.loginFieldsCheck(null)){
          this.$.loginButton.disabled = true;
          this.$.cancelButton.disabled = true;

          this.$.loginSpinner.style.display = "inline-block";
          this.buttonText = "";

          this.$.loginSpinner.active = true;
          
          
          this.$.loginAjax.body = JSON.stringify({'user': this.$.user.value, 'pass': this.$.pass.value });
          this.$.loginAjax.generateRequest();
        }
        
        //document.getElementById('adminlogin').submit();
      },
      reqCB: function(details) {
        //console.log(details);
      },
      loginCallback: function(details) {
        console.log(details.detail.response);
        if(details.detail.response != null) {
          if(details.detail.response.status) {
            this.fire('firetoast', { message: "Logged In!"});
            this.fire('polyquiz-admin-check-status');
          } else if(details.detail.response.status_details != null) { 
            this.fire('firetoast', { message: "Failed To Login! Server Encountered an Error!"});
          } else {
            this.$.pass.value = "";
            this.fire('firetoast', { message: "Invalid Username And/Or Password!"});
          }
        } else {
          this.fire('firetoast', { message: "Failed To Login! Server Encountered an Error! [ " + details.detail.response['status_details'] + " ]"});
        }

        this.$.loginSpinner.active = false;

        this.$.loginSpinner.style.display = "none";
        this.buttonText = "Log In";

        this.$.loginButton.disabled = false;
        this.$.cancelButton.disabled = false;
        this.$.pass.value = "";
        this.loginFieldsCheck(null);
      },
      ready: function() {
        
      }
    });
  </script>
</dom-module>

<dom-module id="sps-app">
  <link rel="import" href="../bower_components/polymer/polymer.html">
  <link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
  <link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
  <link rel="import" href="../bower_components/iron-pages/iron-pages.html">
  <link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
  <link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
  <link rel="import" href="../bower_components/paper-fab/paper-fab.html">
  <link rel="import" href="../bower_components/neon-animation/neon-animations.html">
  <link rel="import" href="../bower_components/neon-animation/neon-animatable.html">
  <link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">


  <link rel="import" href="../bower_components/paper-button/paper-button.html">
  <link rel="import" href="../bower_components/paper-material/paper-material.html">
  <link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
  <link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
  <link rel="import" href="../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
  <link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
  <link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
  <link rel="import" href="../bower_components/paper-menu/paper-menu.html">
  <link rel="import" href="../bower_components/paper-item/paper-item.html">
  <link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
  <link rel="import" href="../bower_components/paper-styles/paper-styles.html">
  <link rel="import" href="../bower_components/paper-toast/paper-toast.html">
  <link rel="import" href="../bower_components/iron-icon/iron-icon.html">
  <link rel="import" href="../bower_components/iron-icons/iron-icons.html">
  <link rel="import" href="../bower_components/iron-icons/social-icons.html">
  <link rel="import" href="../bower_components/iron-icons/maps-icons.html">
  <link rel="import" href="../bower_components/paper-input/paper-input.html">
  <link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
  <link rel="import" href="../bower_components/paper-datatable/paper-datatable.html">

  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <iron-ajax auto id="adminStatusAjax" url="../../api/1.0/admin/" handle-as="json" last-response="{{adminStatus}}"></iron-ajax>
    <paper-drawer-panel id="mainPanel" on-paper-responsive-change="onresp">
      <paper-header-panel drawer class="vertical layout">
        <paper-toolbar>
          <div style="color:#FFFFFF"></div>
        </paper-toolbar>
        <paper-menu id="sidebarMenu" class="flex" attr-for-selected="data-page">
          <paper-icon-item on-click="goToPageOnClick" data-page="signup" hidden="{{computeHiddenIsAdmin(page.adminOnly, isAdmin)}}">
            <iron-icon icon="icons:event-seat" item-icon></iron-icon><span>Sign-Up</span>
          </paper-icon-item>
          <paper-icon-item on-click="goToPageOnClick" data-page="dashboard" hidden="{{computeHiddenIsAdmin(page.adminOnly, isAdmin)}}">
            <iron-icon icon="icons:dashboard" item-icon></iron-icon><span>Dashboard</span>
          </paper-icon-item>
          <paper-icon-item on-click="goToPageOnClick" data-page="presentations" hidden="{{computeHiddenIsAdmin(page.adminOnly, isAdmin)}}">
            <iron-icon icon="social:people" item-icon></iron-icon><span>Presentations</span>
          </paper-icon-item>
          <paper-icon-item on-click="goToPageOnClick" data-page="viewers" hidden="{{computeHiddenIsAdmin(page.adminOnly, isAdmin)}}">
            <iron-icon icon="social:people-outline" item-icon></iron-icon><span>Viewers</span>
          </paper-icon-item>
          <paper-icon-item on-click="goToPageOnClick" data-page="dates" hidden="{{computeHiddenIsAdmin(page.adminOnly, isAdmin)}}">
            <iron-icon icon="icons:date-range" item-icon></iron-icon><span>Dates</span>
          </paper-icon-item>
          <paper-icon-item on-click="goToPageOnClick" data-page="blocks" hidden="{{computeHiddenIsAdmin(page.adminOnly, isAdmin)}}">
            <iron-icon icon="icons:view-list" item-icon></iron-icon><span>Blocks</span>
          </paper-icon-item>
          <paper-icon-item on-click="goToPageOnClick" data-page="locations" hidden="{{computeHiddenIsAdmin(page.adminOnly, isAdmin)}}">
            <iron-icon icon="maps:place" item-icon></iron-icon><span>Locations</span>
          </paper-icon-item>
        </paper-menu>
        <polyquiz-admin-login-form hidden="[[adminStatus.is_admin]]"></polyquiz-admin-login-form>
        <paper-icon-item hidden="[[!adminStatus.is_admin]]" on-click="doLogout">
          Log Out
        </paper-icon-item>
        <paper-item disabled>
        </paper-item>
      </paper-header-panel>
      <paper-scroll-header-panel class="flex" main id="scrollheader" fixed>
        <paper-toolbar>
          <paper-icon-button icon="icons:menu" paper-drawer-toggle></paper-icon-button>
          <span class="title">Senior Presentations - <span>[[pageTitle]]</span></span>
          <paper-button on-click="goToPageOnClick" class="smallbuttons" data-page="home"><iron-icon icon="icons:home"></iron-icon><span class="not-small"> Home</span></paper-button>
          <paper-button on-click="goToPageOnClick" class="smallbuttons" data-page="takeaquiz"><iron-icon icon="icons:content-paste"></iron-icon><span class="not-small"> Take A Quiz</span></paper-button>
          
          <paper-button on-click="goToPageOnClick" class="smallbuttons" data-page="admin"><iron-icon icon="icons:settings"></iron-icon><span class="not-small"> Manage</span></paper-button>
          
        </paper-toolbar>
        <div class="layout horizontal">
          <div class="flex"></div>
          <paper-spinner id="pageLoadSpinner"></paper-spinner>
          <div class="flex"></div>
        </div>
        <neon-animated-pages id="pageSelector" attr-for-selected="data-page" entry-animation="fade-in-animation" exit-animation="fade-out-animation">
          <polyquiz-page-home data-page="home"></polyquiz-page-home>
          <polyquiz-page-takeaquiz data-page="takeaquiz" ctx="[[ctx]]"></polyquiz-page-takeaquiz>
          <polyquiz-page-admin data-page="admin" ctx="[[ctx]]"></polyquiz-page-admin>
          <polyquiz-page-login data-page="login" ctx="[[ctx]]"></polyquiz-page-login>
          <polyquiz-page-sessions data-page="sessions" ctx="[[ctx]]"></polyquiz-page-sessions>
          <polyquiz-page-quiz data-page="quiz" ctx="[[ctx]]"></polyquiz-page-quiz>
          <polyquiz-page-quiz-edit data-page="quizedit" ctx="[[ctx]]"></polyquiz-page-quiz-edit>
        </neon-animated-pages>
        
        <iron-ajax
        id="getLimits"
           auto
           url="../api/1.0/limits/?totals"
           handle-as="json"
           last-response="{{limits}}"></iron-ajax>
          
          <template is="dom-repeat" items="{{_objectArrayToArray(limits)}}">
          
            <paper-datatable data="{{_objectArrayToArray(item)}}" selectable multi-selection>
              <paper-datatable-column header="Presentation" property="presentation_id"></paper-datatable-column>
              <paper-datatable-column header="Grade Level" property="grade_level"></paper-datatable-column>
              <paper-datatable-column header="Total" property="total"></paper-datatable-column>
              <paper-datatable-column header="Limit" property="amount"></paper-datatable-column>
            </paper-datatable>
          </template>
      </paper-scroll-header-panel>
      
    </paper-drawer-panel>
    <paper-toast id="globalToast"></paper-toast>
  </template>
  <script>
    Polymer({
      is: 'sps-app',
      properties: {
        pageTitle: {
          type: String,
          value: "Home"
        },
        limits: {
          type: Object
        },
        adminStatus: {
          type: Object
        }
      },
      listeners: {
        'firetoast': 'fireToast',
        'polyquiz-admin-check-status': 'checkAdminStatus',
        'polyquiz-admin-do-logout': 'doLogout',
        'polyquiz-admin-status': 'onAdminStatusChanged'
      },
      _objectArrayToArray: function(arr) {
        var v = $.map(arr, function(value, index) { return [value]; });
        //console.log(v);
        return $.map(arr, function(value, index) { return [value]; });
      },
      fireToast: function(details) {
        this.fireToastNonEvent(details.detail.message);
      },
      fireToastNonEvent: function(text){
        this.$.globalToast.text = text;
        this.$.globalToast.show();
      },
      doLogout: function(e) {
        this.$.logoutAjax.generateRequest();
      },
      _onResize: function() {
        this.fire('polyquiz-resize');
      },
      goToPageOnClick: function(e) {
        var pageId = "";
        if(e.target.getAttribute('data-page')) {
          pageId = e.target.getAttribute('data-page');
        } else if(e.target.parentNode.getAttribute('data-page')) {
          pageId = e.target.parentNode.getAttribute('data-page');
        }
        page('#!/' + pageId);
      },
      ready: function() {
        //this.$.adminStatusAjax.generateRequest();
        this.$.mainPanel.responsiveWidth = "768px";
        var self = this;
        setInterval(function() {
          self.$.getLimits.generateRequest();
        }, 3000);
      }
    });
  </script>
</dom-module>
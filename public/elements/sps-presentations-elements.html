<!DOCTYPE html>
<dom-module id="sps-presentations-delete-dialog">
<link rel="import" href="../bower_components/paper-datatable/paper-datatable.html">
  <link rel="import" href="../bower_components/ctech-dialogs/ctech-confirm-dialog.html">
  <style is="custom-style">

  </style>

  <template>
    <iron-ajax method="DELETE" id="deleteAjax" url="../api/1.0/presentations/" handle-as="json" on-response="onDeleteResp" content-type="application/json"></iron-ajax>
    <ctech-confirm-dialog id="dialog" on-ctech-dialog-confirm="_onConfirm" on-ctech-dialog-dismiss="_onDismiss" confirm-text="Delete" valid-color="#c62828" modal>
      <h2>Delete The Presentation(s)?</h2>

      <paper-datatable id="dt" data="{{_objectArrayToArray(presentations)}}" filter="{{_myFilter}}">
        <paper-datatable-column header="Name" property="last_name">
          <template>
            <div>{{item.last_name}}, {{item.first_name}}</div>
          </template>
        </paper-datatable-column>
        <paper-datatable-column header="Topic" property="presentation_text"></paper-datatable-column>
      </paper-datatable>
    </ctech-confirm-dialog>
  </template>

  <script>
    var selectedExt = {};
    var _myFilter = function(item, key, items) {
      var show = false;
        for (var key in selectedExt) {
          if (!selectedExt.hasOwnProperty(key)) continue;
          if(item.presentation_id == key) {
            show = true;
            break;
          }
        }
        return show;
      };
    Polymer({
      is: "sps-presentations-delete-dialog",
      properties: {
        presentations: {
          type: Object,
          observer: '_onPresentationsChanged'
        },
        selected: {
          type: Object,
          observer: '_onSelectedChanged'
        }
      },
      _objectArrayToArray: function(arr) {
        var v = $.map(arr, function(value, index) { return [value]; });
        //console.log(v);
        return $.map(arr, function(value, index) { return [value]; });
      },
      _onConfirm: function() {
        var o_out = {};
        for (var key in this.selected) {
          if (!this.selected.hasOwnProperty(key)) continue;
          //key
          o_out[key] = { presentation_id: key };
        }
        this.$.deleteAjax.body = JSON.stringify(o_out);
        this.$.deleteAjax.generateRequest();
      },
      _onDismiss: function(e) {
        
      },
      onDeleteResp: function(e){
        if(e.detail.response.status == true){
          this.fire('firetoast', { message: "Deleted presentation!"});
          this.fire('reload-presentations');
        } else {
          if(e.detail.response.error){
            if(e.detail.response.error == 1451){
              this.fire('firetoast', { message: "Failed to delete presentation! FK error!"});
            }
          } else {
            this.fire('firetoast', { message: "Failed to delete presentation!"});
          }
        }
      },
      _onPresentationsChanged: function(e) {
        this.$.dt.reload();
      },
      _onSelectedChanged: function(e) {
        selectedExt = this.selected;
        if(this.presentations) {
          this.$.dt.reload();
        }
        
      },
      open: function(sessionObject){
        this.sessionObject = sessionObject;
        this.$.dt.reload();
        this.$.dialog.open();

      },
      ready: function(){
        this.$.dt.filter = _myFilter;
      }
    });
  </script>
</dom-module>
<dom-module id="sps-presentations-add-dialog">
  <link rel="import" href="../bower_components/ctech-dialogs/ctech-confirm-dialog.html">
  <link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">
  <link rel="import" href="../bower_components/ctech-dropdown-selector/ctech-dropdown-selector.html">
  <link rel="import" href="../bower_components/paper-input/paper-textarea.html">

  <style is="custom-style">
    .nomargins { 
      margin: 0px;
    }
    paper-dialog {
      background-color: white;
    }
    .validButton {
      background-color: #4285f4;
      color: rgba(255,255,255,1.00);
    }
    paper-button {
      margin-top: 8px;
    }
  </style>
<template>
  <iron-ajax method="POST" id="createAjax" url="../api/1.0/presentations/" handle-as="json" on-response="createResp" content-type="application/json"></iron-ajax>
  
  <ctech-confirm-dialog id="mainDialog" on-ctech-dialog-confirm="reqSubmit" on-ctech-dialog-dismiss="resetForm" confirm-text="Create" valid-color="#8BC34A" modal>
    <div class="layout horizontal">
      <div class="flex"></div>
      <h2>New Presentation</h2>
      <div class="flex"></div>
    </div>
    <div class="layout vertical">
      <paper-input name="firstname" label="First Name" on-input="_validateForm" id="firstname" maxlength="255" char-counter></paper-input>
      <paper-input name="lastname" label="Last Name" on-input="_validateForm" id="lastname" maxlength="255" char-counter></paper-input>
      <paper-input name="topic" label="Topic" on-input="_validateForm" id="topic" maxlength="255" char-counter></paper-input>
      <ctech-dropdown-selector id="houseSelector" default-text="Select a House" items="[[houses]]" attr-for-selected="house_id" attr-for-text="house_name" on-ctech-select="_validateForm" raised></ctech-dropdown-selector>


      <ctech-dropdown-selector id="dateSelector" default-text="Select a Date" items="[[dates]]" attr-for-selected="date" attr-for-text="date" on-ctech-select="_validateForm" raised></ctech-dropdown-selector>
      <ctech-dropdown-selector id="blockSelector" default-text="Select a Block" items="[[blocks]]" attr-for-selected="block_id" attr-for-text="block_name" on-ctech-select="_validateForm" raised></ctech-dropdown-selector>
      <ctech-dropdown-selector id="locationSelector" default-text="Select a Location" items="[[locations]]" attr-for-selected="location_id" attr-for-text="location_name" on-ctech-select="_validateForm" raised></ctech-dropdown-selector>
      <template is="dom-repeat" items="{{_objectArrayToArray(gradesN)}}" as="gradelevel">
        <paper-input label="Max [[gradelevel.grade_name]]" allowed-pattern="[0-9]" auto-validated value="{{gradelevel.amount}}"></paper-input>
      </template>
      
    </div>
  </ctech-confirm-dialog>
</template>
<script>
Polymer({
  is: "sps-presentations-add-dialog",
  properties: {
    quizData: {
      type: Object
    },
    houses: {
      type: Object
    },
    grades: {
      type: Object,
      observer: '_onGradesChanged'
    },
    gradesN: {
      type: Object
    },
    sessionname: String
    
  },
  _onGradesChanged: function(e) {
    this.gradesN = this.grades;
    for (var key in this.grades) {
      if (!this.grades.hasOwnProperty(key)) continue;
      var obj = this.grades[key];
      obj['amount'] = 17;
    }
    //console.log(e);
  },
  _objectArrayToArray: function(arr) {
    var v = $.map(arr, function(value, index) { return [value]; });
    //console.log(v);
    return $.map(arr, function(value, index) { return [value]; });
  },
  open: function() {
    this.$.mainDialog.open();
  },
  test: function(e) {
    console.log(e);
  },
  reqSubmit: function(e){
    var gr_ar = {};
    for (var key in this.grades) {
      if (!this.grades.hasOwnProperty(key)) continue;
      var obj = this.grades[key];
      gr_ar[obj.grade_id] = { 'grade_id': obj.grade_id, 'amount': obj.amount };
    }

    this.$.createAjax.body =
      JSON.stringify({
        'first_name': this.$.firstname.value,
        'last_name': this.$.lastname.value,
        'presentation_text': this.$.topic.value,
        'house_id': this.$.houseSelector.selected.house_id,
        'location_id': this.$.locationSelector.selected.location_id,
        'date': this.$.dateSelector.selected.date,
        'block_id': this.$.blockSelector.selected.block_id,
        'grades': gr_ar
      });
      console.log(this.$.createAjax.body);
    this.$.createAjax.generateRequest();
  },
  createResp: function(e){
    if(e.detail.response.status === true){
      this.resetForm();
      this.fire('firetoast', { message: "Created a new Presentation!"});
      this.fire("reload-presentations", { });
    } else {
      var det = "NO_DETAILS";
      if(e.detail.response.status_details) {
        det = e.detail.response.status_details;
        switch(det) {
          case 1062:
            det = "Duplicate House Name";
            break;
          default:
            break;
        }
      }
      this.fire('firetoast', { message: "FAILED to create a new Presentation! [" + det + "]"});
    }
    
    console.log(e);
  },
  resetForm: function(e){
    this.$.firstname.value = "";
    this.$.lastname.value = "";
    this.$.topic.value = "";
    this.$.houseSelector.select();
    this.$.dateSelector.select();
    this.$.blockSelector.select();
    this.$.locationSelector.select();
    this.$.mainDialog.invalid = true;
  },
  _validateForm: function(e){
    if(this.$.houseSelector.selected
       && this.$.dateSelector.selected
       && this.$.blockSelector.selected
       && this.$.locationSelector.selected
       && this.$.firstname.value.length > 0
       && this.$.lastname.value.length > 0
       && this.$.topic.value.length > 0) {
      this.$.mainDialog.invalid = false;
    } else {
      this.$.mainDialog.invalid = true;
    }
  },
  ready: function(){
    this._validateForm();
  }
});
</script>
</dom-module>

<dom-module id="sps-select-house-overlay">
<link rel="import" href="../bower_components/ctech-dropdown-selector/ctech-dropdown-selector.html">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <paper-dialog id="dialog">
      <h2>Change House</h2>
      <ctech-dropdown-selector
              id="houseSelector"
              default-text="Houses"
              items="{{houses}}" selected="{{item.house_id}}"
              attr-for-selected="house_id" attr-for-text="house_name"></ctech-dropdown-selector>
    </paper-dialog>
    
  </template>
  <script>
    Polymer({
      is: 'sps-select-house-overlay',
      properties:  {
        houses: {
          type: Object
        },
        presentationData: {
          type: Object
        }
      },
      open: function() {
        this.$.dialog.open();
      },
      close: function() {

      },
      ready: function() {

      }
    });
  </script>
</dom-module>